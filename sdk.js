(()=>{var e;!function(e){e.PLAY="PLAY",e.PAUSE="PAUSE",e.STOP="STOP",e.GET_USER_PROFILE="GET_USER_PROFILE",e.GO_TO_GAME="GO_TO_GAME",e.GET_PLAYER_DATA="GET_PLAYER_DATA",e.SET_PLAYER_DATA="SET_PLAYER_DATA",e.GET_SERVER_TIME="GET_SERVER_TIME",e.GET_METAVERSE_PLAYER_DATA="GET_METAVERSE_PLAYER_DATA",e.SET_METAVERSE_PLAYER_DATA="SET_METAVERSE_PLAYER_DATA",e.GET_METAVERSE_GAME_PLAYER_DATA="GET_METAVERSE_GAME_PLAYER_DATA",e.SET_METAVERSE_GAME_PLAYER_DATA="SET_METAVERSE_GAME_PLAYER_DATA",e.ADV_SHOW_MIDGAME="ADV_SHOW_MIDGAME",e.ADV_SHOW_REWARDED="ADV_SHOW_REWARDED"}(e||(e={}));const t=new Set(Object.values(e));class n{constructor(e){this.parentOrigin=e,this.callbacks=new Map,this.listeners=new Map,this.handleResponse=e=>{if(e.origin!==this.parentOrigin||"string"!=typeof e.data)return;let t;try{t=JSON.parse(e.data)}catch(e){return void console.warn("[SDK] Ignoring invalid JSON response")}if(t.messageId&&this.callbacks.has(t.messageId)){const e=this.callbacks.get(t.messageId);if(!e||"WebsiteSDK"!==t.source||t.actionName!==e.actionName)return;return clearTimeout(e.timer),this.callbacks.delete(t.messageId),void(t.error?e.reject(new Error(t.error)):e.resolve(t.payload))}if(t.channel){const e=this.listeners.get(t.channel);e&&e.forEach((e=>{try{e(t.payload)}catch(e){console.error("[SDK] Error in external message handler",e)}}))}},window.addEventListener("message",this.handleResponse)}request(e,n,o=5e3){if(!t.has(e))return Promise.reject(new Error(`[SDK] Action "${e}" is not allowed`));const i=`${Date.now()}-${Math.random()}`,s={source:"WelwiseSDK",actionName:e,messageId:i,payload:n},r=JSON.stringify(s);return new Promise(((t,n)=>{const s=window.setTimeout((()=>{this.callbacks.delete(i),n(new Error(`[SDK] "${e}" timed out after ${o}ms`))}),o);this.callbacks.set(i,{resolve:t,reject:n,actionName:e,timer:s}),window.parent.postMessage(r,this.parentOrigin),console.log("[SDK] postMessage sent:",r,this.parentOrigin)}))}onExternalMessage(e,t){this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push(t)}}class o{constructor(e){this.channel=e}goToGame(t){return console.log("[SDK] PlatformNavigation.goToGame() called"),this.channel.request(e.GO_TO_GAME,{gameId:t})}}var i=function(e,t,n,o){return new(n||(n=Promise))((function(i,s){function r(e){try{c(o.next(e))}catch(e){s(e)}}function a(e){try{c(o.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,a)}c((o=o.apply(e,t||[])).next())}))};class s{constructor(e){this.channel=e}getData(){return i(this,void 0,void 0,(function*(){return console.log("[SDK] player.getData() called"),this.channel.request(e.GET_PLAYER_DATA)}))}setData(t){return i(this,void 0,void 0,(function*(){return console.log("[SDK] player.setData() called",t),this.channel.request(e.SET_PLAYER_DATA,t)}))}}class r{constructor(){const e=window.parent;if(!e.AppEnvironment)throw new Error("[SDK] Environment data is not defined");this.env=e.AppEnvironment}get PlayerId(){return this.env.playerId}get DeviceType(){return this.env.deviceType}get LanguageCode(){return this.env.language}}var a,c=function(e,t,n,o){return new(n||(n=Promise))((function(i,s){function r(e){try{c(o.next(e))}catch(e){s(e)}}function a(e){try{c(o.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,a)}c((o=o.apply(e,t||[])).next())}))};class l{constructor(e){this.channel=e}getData(){return c(this,void 0,void 0,(function*(){return console.log("[SDK] metaversePlayer.getData() called"),this.channel.request(e.GET_METAVERSE_PLAYER_DATA)}))}setData(t){return c(this,void 0,void 0,(function*(){return console.log("[SDK] metaversePlayer.setData() called",t),this.channel.request(e.SET_METAVERSE_PLAYER_DATA,t)}))}getGameData(){return c(this,void 0,void 0,(function*(){return console.log("[SDK] metaversePlayer.getGameData() called"),this.channel.request(e.GET_METAVERSE_GAME_PLAYER_DATA)}))}setGameData(t){return c(this,void 0,void 0,(function*(){return console.log("[SDK] metaversePlayer.setGameData() called",t),this.channel.request(e.SET_METAVERSE_GAME_PLAYER_DATA,t)}))}}!function(e){e[e.Opened=0]="Opened",e[e.Rewarded=1]="Rewarded",e[e.Closed=2]="Closed"}(a||(a={}));class d{constructor(e){this.channel=e,this.callbacks={},this.rewardedState=a.Closed,this.adInProgress=!1,this.onAdvManagerExternalMessage=e=>{var t,n,o,i,s,r,c,l,d,h,u,w,f,v;const{action:D,data:S}=e;switch(D){case"adv-callback-open":null===(n=(t=this.callbacks).onOpen)||void 0===n||n.call(t);break;case"adv-callback-close":this.adInProgress=!1,null===(i=(o=this.callbacks).onClose)||void 0===i||i.call(o);break;case"adv-callback-error":this.adInProgress=!1,null===(r=(s=this.callbacks).onError)||void 0===r||r.call(s,new Error(S.error.message));break;case"rewarded-video-callback-open":this.rewardedState=a.Opened,null===(l=(c=this.callbacks).onOpen)||void 0===l||l.call(c);break;case"rewarded-video-callback-rewarded":this.rewardedState=a.Rewarded,null===(h=(d=this.callbacks).onRewarded)||void 0===h||h.call(d);break;case"rewarded-video-callback-close":this.adInProgress=!1,this.rewardedState=a.Closed,null===(w=(u=this.callbacks).onClose)||void 0===w||w.call(u);break;case"rewarded-video-callback-error":this.adInProgress=!1,null===(v=(f=this.callbacks).onError)||void 0===v||v.call(f,new Error(S.error.message))}},this.channel.onExternalMessage("adv-manager",this.onAdvManagerExternalMessage)}ensureCallbacksIsValid(e,t){const n=["onClose","onError"];"showRewarded"===e&&n.push("onRewarded");const o=n.filter((e=>!(e in t&&"function"==typeof t[e])));o.length&&console.warn(`Missing callbacks for ${e}: ${o.join(", ")}`)}setCallbacks(e,t){this.callbacks={};for(const n of t){const t=e[n];t&&(this.callbacks[n]=t)}}showMidgame(t={}){if(this.adInProgress)return void console.warn("[SDK] showMidgame called while ad in progress");this.adInProgress=!0;const n=t.callbacks||{};this.ensureCallbacksIsValid("showMidgame",n),this.channel.request(e.ADV_SHOW_MIDGAME).then((e=>{var t,o;if(e.error){const i=new Error(e.error.message);console.warn(i),this.adInProgress=!1,null===(t=n.onError)||void 0===t||t.call(n,i),null===(o=n.onClose)||void 0===o||o.call(n)}else this.setCallbacks(n,["onOpen","onClose","onError"])})).catch((e=>{var t,o;console.error(e),this.adInProgress=!1,null===(t=n.onError)||void 0===t||t.call(n,e),null===(o=n.onClose)||void 0===o||o.call(n)}))}showRewarded(t={}){if(this.adInProgress)return void console.warn("[SDK] showRewarded called while ad in progress");this.adInProgress=!0;const n=t.callbacks||{};this.ensureCallbacksIsValid("showRewarded",n),this.channel.request(e.ADV_SHOW_REWARDED).then((e=>{var t,o;if(e.error){const i=new Error(e.error.message);console.warn(i),this.adInProgress=!1,null===(t=n.onError)||void 0===t||t.call(n,i),null===(o=n.onClose)||void 0===o||o.call(n)}else this.setCallbacks(n,["onOpen","onRewarded","onClose","onError"])})).catch((e=>{var t,o;console.error(e),this.adInProgress=!1,null===(t=n.onError)||void 0===t||t.call(n,e),null===(o=n.onClose)||void 0===o||o.call(n)}))}}class h{constructor(e,t){this.parentOrigin=e,this.channel=new n(this.parentOrigin),this.features=t,this.PlatformNavigation=new o(this.channel),this.player=new s(this.channel),this.metaversePlayer=new l(this.channel),this.AdvManager=new d(this.channel),this.Environment=new r}serverTime(){return t=this,o=function*(){return console.log("[SDK] pause() called"),this.channel.request(e.GET_SERVER_TIME)},new((n=void 0)||(n=Promise))((function(e,i){function s(e){try{a(o.next(e))}catch(e){i(e)}}function r(e){try{a(o.throw(e))}catch(e){i(e)}}function a(t){var o;t.done?e(t.value):(o=t.value,o instanceof n?o:new n((function(e){e(o)}))).then(s,r)}a((o=o.apply(t,[])).next())}));var t,n,o}isMetaverseSupported(){return!!this.features.metaverse}}class u{constructor(){throw new Error("[SDK] Use WelwiseGames.init() instead of constructor")}static init(){return e=this,n=function*(){if(console.log("[SDK] init() called"),u.instance)return console.warn("[SDK] init(): SDK already was initializated"),u.instance;const{hasParent:e,parentOrigin:t,features:n}=yield function(){return e=this,n=function*(){return console.log("[SDK] Starting handshake with parent frame"),window.parent&&window.parent!==window?new Promise((e=>{const t=Date.now();let n=!1;const o=`${Date.now()}-${Math.random()}`;console.log(`[SDK] Sending handshake request, messageId=${o}`);const i=r=>{var a,c;if("string"!=typeof r.data)return void console.warn("[SDK] Ignoring message: not a string");let l;try{l=JSON.parse(r.data)}catch(e){return void console.warn("[SDK] Ignoring message: invalid JSON")}if("WebsiteSDK"!==l.source||"GET_IFRAME_ORIGIN_SRC"!==l.actionName||l.messageId!==o)return void console.warn("[SDK] Ignoring message: unexpected fields",`source=${l.source}, actionName=${l.actionName}, messageId=${l.messageId}`);const d=Date.now()-t;console.log(`[SDK] âœ… Handshake response received in ${d} ms, payload.origin=`,null===(a=l.payload)||void 0===a?void 0:a.origin),n=!0,window.removeEventListener("message",i),clearTimeout(s);const h="string"==typeof(null===(c=l.payload)||void 0===c?void 0:c.origin)?l.payload.origin:null,u="object"==typeof l.payload.features&&null!==l.payload.features?l.payload.features:{};e({hasParent:!0,parentOrigin:h,features:u})};window.addEventListener("message",i),window.parent.postMessage(JSON.stringify({source:"WelwiseSDK",actionName:"GET_IFRAME_ORIGIN_SRC",messageId:o}),"*");const s=setTimeout((()=>{n||(console.warn("[SDK] Parent frame did not respond to handshake within timeout"),window.removeEventListener("message",i),e({hasParent:!0,parentOrigin:null,features:{}}))}),3e3)})):(console.log("[SDK] No parent frame found: communication disabled"),{hasParent:!1,parentOrigin:null,features:{}})},new((t=void 0)||(t=Promise))((function(o,i){function s(e){try{a(n.next(e))}catch(e){i(e)}}function r(e){try{a(n.throw(e))}catch(e){i(e)}}function a(e){var n;e.done?o(e.value):(n=e.value,n instanceof t?n:new t((function(e){e(n)}))).then(s,r)}a((n=n.apply(e,[])).next())}));var e,t,n}();if(!e||!t)throw console.error("[SDK] Handshake failed: SDK unavailable"),new Error("[SDK] Handshake with parent frame failed. SDK unavailable.");return console.log("[SDK] Handshake successful: Creating API wrapper"),u.instance=new h(t,n),console.log("[SDK] Initialization complete"),u.instance},new((t=void 0)||(t=Promise))((function(o,i){function s(e){try{a(n.next(e))}catch(e){i(e)}}function r(e){try{a(n.throw(e))}catch(e){i(e)}}function a(e){var n;e.done?o(e.value):(n=e.value,n instanceof t?n:new t((function(e){e(n)}))).then(s,r)}a((n=n.apply(e,[])).next())}));var e,t,n}}u.instance=null,window.WelwiseGames=u})();